<html>
<head><title>barebones.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
html, body { border:0px;margin:0px;padding:0px; color:white; background-color:black;}
#game-canvas { width:100%; border:0px;margin:0px;padding:0px; }
</style>
<script type="text/javascript">

var gl, canvas, splash, audio, messages, keys = {}, perf;

function game() { // you replace this!
	game.g3d_test = new G3D("data/test.g3d");
	var win = UIWindow(true,UIPanel([
		UIPanel([UILabel("this is a test"),
			UILabel("this too"),
			UIButton("click me!",function(evt) { win.hide(); }),]),
			UIPanel([UILabel("this is a test"),UILabel("this too")]),
	],UILayoutRows));
	win.show();
}

function render() { // you replace this!
	gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);
	var zoom = 2,
		pMatrix = createPerspective(60.0,canvas.offsetWidth/canvas.offsetHeight,0.1,zoom*2),
		mvMatrix = createLookAt([zoom,zoom*0.8,zoom],[0,0,0],[0,1,0]),
		nMatrix = mat4_inverse(mat4_transpose(mvMatrix));
	game.g3d_test.draw((now()/1000)%1,pMatrix,mvMatrix,nMatrix);
}

function init() {
	canvas = document.getElementById("game-canvas");
	try {
		gl = canvas.getContext("webgl") || canvas.getContext("experimental-webgl");
	} catch(e) {
		console.log("Error initializing webGL:",e);
	}
	if(!gl) {
		console.log(gl);
		alert("Unable to initialize WebGL. Your browser may not support it.");
		return;
	}
	window.onerror = function(msg,url,lineno) {
		console.log("ERROR:",msg,url,lineno);
		if(fail.error) return;
		fail.error = true;
		alert("ERROR "+url+"#"+lineno+"\n"+msg);
	};
  	window.onresize = function() {
  		canvas.style.height = (window.innerHeight - canvas.offsetTop)+"px";
		canvas.width = canvas.offsetWidth;
		canvas.height = canvas.offsetHeight;
		gl.viewport(0,0,canvas.offsetWidth,canvas.offsetHeight);
	};
	window.onresize();
	var audioFactory = window.webkitAudioContext || window.mozAudioContext;
	if(audioFactory)
		audio = new audioFactory();
	var 	isMouseDown = false,
		onMouseDown = function(evt) {
			evt.cancelBubble = true;
			isMouseDown = true;
			if(evt.target !== canvas)
				return false;
			if(!onMouseDownUI(evt,keys) && window.onMouseDown)
				window.onMouseDown(evt,keys);
			schedule.run();
			return false;
		},
		onMouseMove = function(evt) {
			evt.cancelBubble = true;
			if(evt.target !== canvas)
				return;
			if(isMouseDown && window.onMouseMove)
				window.onMouseMove(evt,keys);
			schedule.run();
		},
		onMouseUp = function(evt) {
			evt.cancelBubble = true;
			isMouseDown = false;
			if(evt.target !== canvas)
				return false;
			if(!onMouseUpUI(evt,keys) && window.onMouseUp)
				window.onMouseUp(evt,keys);
			schedule.run();
			return false;
		},
		onContextMenu = function(evt) {
			evt.cancelBubble = true;
			evt.preventDefault();
			if(!baseMouseEvent(evt))
				return;
			if(!onContextMenuUI(evt,keys) && window.onContextMenu)
				window.onContextMenu(evt,keys);
			schedule.run();
			return false;
		},
		onKeyDown = function(evt) {
			evt.cancelBubble = true;
			if(!keys[evt.which]) {
				keys[evt.which] = true;
				if(window.onKeyDown)
					window.onKeyDown(evt,keys);
			}
			schedule.run();
			return false;
		},
		onKeyUp = function(evt) {
			evt.cancelBubble = true;
			if(keys[evt.which]) {
				keys[evt.which] = false;
				if(window.onKeyUp)
					window.onKeyUp(evt,keys);
			}
			schedule.run();
			return false;
		};
	var loaded = Waiter(function() {
			document.addEventListener("mousedown",onMouseDown,true);
			document.addEventListener("mouseup",onMouseUp,true);
			document.addEventListener("mousemove",onMouseMove,true);
			document.addEventListener("contextmenu",onContextMenu,true);
			document.addEventListener("keydown",onKeyDown,true);
			document.addEventListener("keyup",onKeyUp,true);
			window.focus();
			window.requestAnimFrame(loop);
			perf = new Perf();
			perf.window().show();
			game();
		});
	loadFile("javascript","glutil.js",loaded());
	loadFile("javascript","ui.js",loaded());
	loadFile("javascript","g3d.js",loaded());
}

function addMessage(secs,from,text,tag) {
	var 	f = from? UILabel(from): null,
		message = UIPanel(f?[f,UILabel(text)]:[UILabel(text)]);
	message.bgColour = [0.2,0.2,0.2,1];
	message.tag = tag;
	if(f) f.fgColour = [0.8,1,0.8,1];
	if(!messages) {
		messages = UIWindow(false,UIPanel([],false,UILayoutRows));
		messages.show();
	}
	var old = tag? getMessage(tag): null;
	if(old) {
		old.parent.replaceChild(old,message);
		if(old.dismisser) clearTimeout(old.dismisser);
	} else
		messages.ctrl.addChild(message);
	if(secs) message.dismisser = setTimeout(function() { message.destroy(); },secs*1000);
}

function getMessage(tag) {
	if(messages)
		for(var message in messages.ctrl.children) {
			message = messages.ctrl.children[message];
			if(message.tag == tag)
				return message;
		}
	return null;
}

function removeMessage(tag) {
	var message = getMessage(tag);
	if(message) message.destroy();
	return message != null;
}

function isUndefined(o) { return typeof(o) === "undefined"; }
function isDefined(o) { return typeof(o) !== "undefined"; }

function assert(condition,msg) {
	if(!condition) fail("ASSERTION FAILED\n"+(msg||"an error occurred"));
}

function fail(msg) {
	fail.error = new Error(msg);
	throw fail.error;
}

function extend(a,b) {
	for(var attr in b) {
		a[attr] = b[attr];
	}
	return a;
};

function now() { return (new Date()).getTime(); }

function loop() {
	if(fail.error) return;
	try {
		window.requestAnimFrame(loop);
		schedule.run();
		if(canvas.width && canvas.height) {
			if(window.render) {
				(window.perf)
					perf.tick();
				render();
			}
			drawUI(canvas);
		}
	} catch(e) {
		fail.error = e;
		console.log("ERROR:",e);
		console.log(e.stack||"<no stack>");
		alert("ERROR "+e+"\n"+(e.stack||"<no stack>"));
	}
}

function Waiter(readyCallback) {
	var waiter = function(msg) {
		waiter.outstanding.push(msg);
		return function() {
			waiter.outstanding.splice(waiter.outstanding.indexOf(msg),1);
			if(waiter.outstanding.length==0)
				readyCallback();
		};
	};
	waiter.outstanding = [];
	return waiter;
}         

function loadFile(type,path,callback) {
	loadFile.loading = loadFile.loading || [];
	loadFile.loadingWait = loadFile.loadingWait || null;
	loadFile.loaded = loadFile.loaded || [];
	console.log("loading",type,path,"...");
	if(path in loadFile.loaded) {
		setTimeout(function() { callback(loadFile.loaded[path]); },0);
		return;
	}
	if(path in loadFile.loading) {
		loadFile.loading[path].push(callback);
		return;
	}
	loadFile.loading[path] = [callback];
	if(loadFile.loadingWait) clearTimeout(loadFile.loadingWait);
	loadFile.loadingWait = setTimeout(function() {
		alert("it's taking a long time to load all the files!  Maybe something is wrong?");
		console.log("awaiting load of:",loadFile.loading);
		},3000);
	var done = function(arg) {
		console.log("loaded",type,path);
		loadFile.loaded[path] = arg;
		var callbacks = loadFile.loading[path];
		delete loadFile.loading[path];
		if(!loadFile.loading.length) clearTimeout(loadFile.loadingWait);
		for(callback in callbacks)
			if(callbacks[callback])
				callbacks[callback](arg);
	};
	if(type == "javascript") {
		var script = document.createElement('script');
		script.setAttribute("type","text/javascript");
		script.setAttribute("src",path);
		script.async = true;
		script.onload = function() {
			if(!script.readyState || script.readyState == "loaded" || script.readyState == "complete")
				done(script);
			else
				console.log("loading state:",type,path,script.readyState);
		};
		document.getElementsByTagName("head")[0].appendChild(script);
	} else if(type == "image") {
		var image = new Image();
		image.onload = function() {
			done(createTexture(null,null,image));
		};
		image.src = path;
	} else if(type == "xml") {
		var doc = new XMLHttpRequest();
		doc.open("GET",path,true);
		doc.onreadystatechange = function() {
			if (doc.readyState==4 && (!doc.status || doc.status==200))
				done(doc.responseXML);
		};
		doc.send();
	} else if(type == "ArrayBuffer") {
		var doc = new XMLHttpRequest();
		doc.open("GET",path,true);
		doc.responseType = "arraybuffer";
		doc.overrideMimeType('text/plain; charset=x-user-defined');
		doc.onreadystatechange = function() {
			if (doc.readyState==4 && (!doc.status || doc.status==200))
				done(doc.response);
		};
		doc.send();
	} else if(type == "audio") {
		var doc = new XMLHttpRequest();
		doc.open("GET",path,true);
		doc.responseType = "arraybuffer";
		doc.overrideMimeType('text/plain; charset=x-user-defined');
		doc.onreadystatechange = function() {
			if (doc.readyState==4 && (!doc.status || doc.status==200))
				audio.decodeAudioData(doc.response,done);
		};
		doc.send();
	} else
		console.log("unsupported type",type,path);
}

function randomSound(list) {
	if(list.length && audio)
		playSound(list[Math.floor(Math.random()*list.length)]);
}

function playSound(clip,volume) {
	var source = audio.createBufferSource();
	source.buffer = clip;
	if(volume) {
		var gainNode = audio.createGainNode();
		source.connect(gainNode);
		gainNode.connect(audio.destination);
		gainNode.gain.value = volume;
	} else
		source.connect(audio.destination);
	source.noteOn(0);
}

function schedule(func) {
	schedule._items.push(func);
}

schedule._items = [];

schedule.run = function() {
	for(var items = schedule._items; items.length; items = schedule._items) {
		schedule._items = [];
		for(var i in items)
			items[i]();
	}
};


window.requestAnimFrame = 
	window.requestAnimationFrame ||
	window.webkitRequestAnimationFrame ||
	window.mozRequestAnimationFrame ||
	window.oRequestAnimationFrame ||
	window.msRequestAnimationFrame ||
	function(callback) {
		window.setTimeout(callback, 1/60);
	};

</script>
<body onload="init()">
<noscript>
Sorry, you don't have Javascript enabled :(
</noscript>
<div id="upload">
	<form action="/upload" enctype="multipart/form-data" method="post">
		&nbsp;file&nbsp;<input type="file" name="file" size="40"/>
		&nbsp;path&nbsp;<input type="text" name="folder" size="10" value="/"/>
		&nbsp;message&nbsp;<input type="text" name="message" size="10" value="(edited online)"/>
		<input type="submit" value="upload!"/>
	</form>
</div>
<canvas id="game-canvas">
Sorry, you don't have webGL enabled :(
</canvas>
</body>
</html>
